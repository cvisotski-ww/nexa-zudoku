{"version":3,"file":"zudoku.auth-clerk.js","sources":["../src/lib/authentication/providers/clerk.tsx"],"sourcesContent":["import type { Clerk } from \"@clerk/clerk-js\";\nimport { ClerkAuthenticationConfig } from \"../../../config/config.js\";\nimport { AuthenticationProviderInitializer } from \"../authentication.js\";\nimport { AuthenticationPlugin } from \"../AuthenticationPlugin.js\";\nimport { useAuthState } from \"../state.js\";\n\nclass ClerkAuthPlugin extends AuthenticationPlugin {\n  constructor(private clerk: Promise<Clerk | undefined>) {\n    super();\n  }\n  initialize = async () => {\n    const clerk = await this.clerk;\n\n    if (!clerk) {\n      return;\n    }\n\n    if (clerk.session) {\n      useAuthState.setState({\n        isAuthenticated: true,\n        isPending: false,\n        profile: {\n          sub: clerk.session.user.id,\n          name: clerk.session.user.fullName ?? undefined,\n          email: clerk.session.user.emailAddresses[0]?.emailAddress,\n          emailVerified: false, // TODO: Check this\n          pictureUrl: clerk.session.user.imageUrl,\n        },\n      });\n    } else {\n      useAuthState.setState({\n        isAuthenticated: false,\n        isPending: false,\n        profile: undefined,\n      });\n    }\n  };\n}\n\nconst clerkAuth: AuthenticationProviderInitializer<\n  ClerkAuthenticationConfig\n> = ({\n  clerkPubKey,\n  redirectToAfterSignOut = \"/\",\n  redirectToAfterSignUp = \"/\",\n  redirectToAfterSignIn = \"/\",\n}) => {\n  let clerkApi: Clerk;\n  const ensureLoaded = (async () => {\n    if (typeof window === \"undefined\") return;\n    const { Clerk } = await import(\"@clerk/clerk-js\");\n    clerkApi = new Clerk(clerkPubKey);\n\n    await clerkApi.load();\n    return clerkApi;\n  })();\n\n  async function getAccessToken() {\n    await ensureLoaded;\n    if (!clerkApi.session) {\n      throw new Error(\"No session available\");\n    }\n    const response = await clerkApi.session.getToken();\n    if (!response) {\n      throw new Error(\"Could not get access token from Clerk\");\n    }\n    return response;\n  }\n\n  return {\n    getAccessToken,\n    signOut: async () => {\n      await ensureLoaded;\n      await clerkApi.signOut({\n        redirectUrl: window.location.origin + redirectToAfterSignOut,\n      });\n    },\n    signIn: async () => {\n      await ensureLoaded;\n      await clerkApi.redirectToSignIn({\n        signInForceRedirectUrl: window.location.origin + redirectToAfterSignIn,\n        signUpForceRedirectUrl: window.location.origin + redirectToAfterSignUp,\n      });\n    },\n    signUp: async () => {\n      await ensureLoaded;\n      await clerkApi.redirectToSignUp({\n        signInForceRedirectUrl: window.location.origin + redirectToAfterSignIn,\n        signUpForceRedirectUrl: window.location.origin + redirectToAfterSignUp,\n      });\n    },\n    getAuthenticationPlugin() {\n      return new ClerkAuthPlugin(ensureLoaded);\n    },\n  };\n};\n\nexport default clerkAuth;\n"],"names":["ClerkAuthPlugin","AuthenticationPlugin","clerk","__publicField","useAuthState","_a","clerkAuth","clerkPubKey","redirectToAfterSignOut","redirectToAfterSignUp","redirectToAfterSignIn","clerkApi","ensureLoaded","Clerk","getAccessToken","response"],"mappings":";;;;;AAMA,MAAMA,UAAwBC,EAAqB;AAAA,EACjD,YAAoBC,GAAmC;AAC/C;AAER,IAAAC,EAAA,oBAAa,YAAY;;AACjB,YAAAD,IAAQ,MAAM,KAAK;AAEzB,MAAKA,MAIDA,EAAM,UACRE,EAAa,SAAS;AAAA,QACpB,iBAAiB;AAAA,QACjB,WAAW;AAAA,QACX,SAAS;AAAA,UACP,KAAKF,EAAM,QAAQ,KAAK;AAAA,UACxB,MAAMA,EAAM,QAAQ,KAAK,YAAY;AAAA,UACrC,QAAOG,IAAAH,EAAM,QAAQ,KAAK,eAAe,CAAC,MAAnC,gBAAAG,EAAsC;AAAA,UAC7C,eAAe;AAAA;AAAA,UACf,YAAYH,EAAM,QAAQ,KAAK;AAAA,QACjC;AAAA,MAAA,CACD,IAEDE,EAAa,SAAS;AAAA,QACpB,iBAAiB;AAAA,QACjB,WAAW;AAAA,QACX,SAAS;AAAA,MAAA,CACV;AAAA,IACH;AA5BkB,SAAA,QAAAF;AAAA,EAEpB;AA4BF;AAEA,MAAMI,IAEF,CAAC;AAAA,EACH,aAAAC;AAAA,EACA,wBAAAC,IAAyB;AAAA,EACzB,uBAAAC,IAAwB;AAAA,EACxB,uBAAAC,IAAwB;AAC1B,MAAM;AACA,MAAAC;AACJ,QAAMC,KAAgB,YAAY;AAC5B,QAAA,OAAO,SAAW,IAAa;AACnC,UAAM,EAAE,OAAAC,EAAA,IAAU,MAAM,OAAO,iBAAiB;AACrC,WAAAF,IAAA,IAAIE,EAAMN,CAAW,GAEhC,MAAMI,EAAS,QACRA;AAAA,EAAA;AAGT,iBAAeG,IAAiB;AAE1B,QADE,MAAAF,GACF,CAACD,EAAS;AACN,YAAA,IAAI,MAAM,sBAAsB;AAExC,UAAMI,IAAW,MAAMJ,EAAS,QAAQ,SAAS;AACjD,QAAI,CAACI;AACG,YAAA,IAAI,MAAM,uCAAuC;AAElD,WAAAA;AAAA,EACT;AAEO,SAAA;AAAA,IACL,gBAAAD;AAAA,IACA,SAAS,YAAY;AACb,YAAAF,GACN,MAAMD,EAAS,QAAQ;AAAA,QACrB,aAAa,OAAO,SAAS,SAASH;AAAA,MAAA,CACvC;AAAA,IACH;AAAA,IACA,QAAQ,YAAY;AACZ,YAAAI,GACN,MAAMD,EAAS,iBAAiB;AAAA,QAC9B,wBAAwB,OAAO,SAAS,SAASD;AAAA,QACjD,wBAAwB,OAAO,SAAS,SAASD;AAAA,MAAA,CAClD;AAAA,IACH;AAAA,IACA,QAAQ,YAAY;AACZ,YAAAG,GACN,MAAMD,EAAS,iBAAiB;AAAA,QAC9B,wBAAwB,OAAO,SAAS,SAASD;AAAA,QACjD,wBAAwB,OAAO,SAAS,SAASD;AAAA,MAAA,CAClD;AAAA,IACH;AAAA,IACA,0BAA0B;AACjB,aAAA,IAAIT,EAAgBY,CAAY;AAAA,IACzC;AAAA,EAAA;AAEJ;"}